<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">  
    <title>录屏小工具</title>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    
</head>

<body bgcolor="#323232">
    <style>
        .center {
            text-align: center;
            display: block;
        }

        .button_style_1 {
            background-color: #3331a1;
            padding: 10px;
            position: relative;
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
            text-decoration: none;
            color: #fff;
            border: solid 1px #3331a1;
            background-image: linear-gradient(bottom, rgb(109, 94, 192) 0%, rgb(212, 51, 51) 100%);
            border-radius: 5px;
        }

        .button_style_1:active {
            padding-bottom: 9px;
            padding-left: 10px;
            padding-right: 10px;
            padding-top: 11px;
            top: 1px;
            background-image: linear-gradient(bottom, #3331a1 100%, rgb(212, 51, 51) 0%);
        }

        .cpr {
            display: block;
            text-align: center;
            color: #7479c2;
        }

        .cpr_1 {
            display: block;
            text-align: center;
            color: #a7abe6;
        }
    </style>
    <div class="center">
        <img src="./images/camara_title.png" alt="加载图片出错" width="50" height="70">
    </div>
    <h1 class="center" style="color: rgb(62, 112, 206);">录 屏 小 工 具</h1>
    <p class="cpr">by BD_Richie</p>
    <a href="./readme.html" class="cpr_1">使用说明</a>
    <br>
    <div class="center">
        <button id="start" class="button_style_1">屏幕获取</button>
        <button id="record" class="button_style_1">开始录制</button>
        <button id="stop" class="button_style_1">结束录制</button>
        <button id="download" class="button_style_1">下载视频</button>
    </div>
    <div class="center">
        <br />
        <input type="checkbox" id="idr"><labelr="idr"> 捕捉音频</label>
    </div>
    <br />
    <video autoplay playsinline id="player" height="500" width="100%"></video>
    <script>
        let allStream;
        let buf = [];
        let mediaRecorder;

        const checkboxer = document.querySelector("#idr");

        setInterval(function(){
            console.warn("checkbox触发状态:"+checkboxer.checked);
        },10000);
        document.querySelector('#start').onclick = function () {
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                if (checkboxer.checked) {
                    navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    }).then((stream) => {
                        allStream = stream;
                        document.querySelector("#player").srcObject = stream;
                    }).catch((err) => {
                        console.error("错误!", err);
                    })
                } else {
                    navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: false
                    }).then((stream) => {
                        allStream = stream;
                        document.querySelector("#player").srcObject = stream;
                    }).catch((err) => {
                        console.error("错误!", err);
                    })
                }
            } else {
                alert("不支持这个特性");
            }
        }
        document.querySelector('#record').onclick = function () {
            // 约束视频格式
            const options = {
                mimeType: 'video/webm;codecs=vp8'
            }
            // 判断是否是支持的mimeType格式
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                console.error('不支持的视频格式');
                return;
            }
            try {
                mediaRecorder = new MediaRecorder(allStream, options);
                // 处理采集到的事件
                mediaRecorder.ondataavailable = function (e) {
                    if (e && e.data && e.data.size > 0) {
                        // 存储到数组中
                        buf.push(e.data);
                    }
                };
                // 开始录制
                mediaRecorder.start(10);
            } catch (e) {
                console.error(e);
            }
        }
        document.querySelector("#download").onclick = function () {
            mediaRecorder.stop();
            if (buf.length) {
                const blob = new Blob(buf, { type: "video/webm" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                let date = new Date();
                var downloadName = date.getFullYear().toString() + "_" + (date.getMonth + 1).toString() + "_" + date.getDate().toString() + "_Record_Video"
                a.href = url;
                a.style.display = "none";
                a.download = downloadName + ".webm"
                a.click();
            } else {
                alert("还没有录制任何内容")
            }
        }
        document.querySelector("#stop").onclick = function () {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }
    </script>
</body>

</html>